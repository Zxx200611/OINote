给出一棵 $n$ 个结点的树，和两组路径 $Q$，$A$，其中 $A$ 中的第 $i$ 条路径有一个权值 $c_i$，$Q$ 中的第 $i$​ 条路径有一个 $k_i$。

对于 $Q$ 中的每一条路径 $Q_i$，求出 $A$ 中被 $Q_i$ 的包含的路径 $A_j$ 中 $c_j$ 的第 $k_i$ 小值。

---

看到离线第 $k$ 小，可以想到整体二分。

每次将 $A$ 中权值为 $[l,mid]$ 中的路径插入某数据结构中，查询 $Q$ 中的路径包含多少数据结构中的路径即可。



现在就只用考虑如何在较短的时间内对于 $A$​ 中的某些路径所组成的集合 $A'$​，求出一条路径包含了多少其中的路径。

定义 $d_i$ 为第 $i$​ 个点的 dfs 序，$[L_i,R_i]$ 为点 $i$ 的子树的 dfs 序区间。

考虑一条路径 $[a,b]$​​ 如何包含 $[u,v]$​​，不妨设 $d_u \le d_v$​​，$d_a \le d_b$​​，分类讨论：

1. $[u,v]$​​ 不为一条深度递增的链，即 $\operatorname{lca} (u,v) \neq u$​​​：

    则点 $a$​​ 一定要在点 $u$​ 的子树中，点 $b$​ 一定要在点 $v$​ 的子树中。

    即点 $(d_a,d_b)$​​​ 要在矩形 $[(L_u,L_v),(R_u,R_v)]$​​ 中。

2. $[u,v]$​ 为一条深度递增的链，即 $\operatorname{lca} (u,v) = u$​：

    则点 $a$​ 一定在 $u$​ 至 $v$​ 的路径上第一个点 $w$ 的子树外，点 $b$ 一定在 $v$ 的子树中。

    即点 $(d_a,d_b)$ 要在矩形 $[(1,L_v),(L_w-1,R_v)]$ 或 $[(R_w+1,L_v),(n,R_v)]$ 中。注意这两个矩形是不交的。

那么只需要用扫描线从左到右扫，使用树状数组维护扫描线即可。

求 $u$ 至 $v$ 路径上的第 $1$ 个点可以使用倍增在 $O(\log n)$ 的时间内求出。

总时间复杂度为 $O(n \log^2 n)$，足以通过​

至此本题解决。



经验：

+ 树上路径包含问题可以用 dfs 序转化为点是否被矩阵包含的问题。
+ 离线多次询问第 $k$ 小可以整体二分。